<!DOCTYPE html>
<html>
<head>
    <title>Nearby Vessels</title>
    <link rel="stylesheet" href="/static/leaflet.css"/>
</head>
<body>
    <h1>Nearby Vessels</h1>
    Latitude: <input id="lat" type="number" value="18.9388" step="0.0001">
    Longitude: <input id="lon" type="number" value="72.8258" step="0.0001">
    Distance (m): <input id="distance" type="number" value="10000">
    <button onclick="searchVessels()">Search</button>
    
    
    <div id="map" style="height: 500px"></div>
    <!-- <div id="coords" style="position: fixed; bottom: 10px; left: 10px; background: white; padding: 5px; border: 1px solid #ccc;">
    Lat: -, Lon: -
    </div> -->

    <div id="coords" style="
    position: fixed;
    bottom: 10px;
    left: 10px;
    background: white;
    padding: 5px 8px;
    border: 1px solid #ccc;
    font-family: Arial, sans-serif;
    font-size: 14px;
    z-index: 1000;">
    Lat: -, Lon: -
    </div>
    

<script src="/static/leaflet.js"></script>
<script>
document.getElementById("coords").style.display = "block";

// Create a LayerGroup to store markers
var map = L.map('map').setView([18.9388, 72.8258], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

map.on("mousemove", function(e) {
    document.getElementById("coords").innerText =
        `Lat: ${e.latlng.lat.toFixed(5)}, Lon: ${e.latlng.lng.toFixed(5)}`;
});

fetch("/static/india-boundary.geojson")   // local file in your static folder
  .then(response => {
    if (!response.ok) throw new Error("Network error " + response.status);
    return response.json();
  })
  .then(data => {
    console.log("GeoJSON loaded:", data);

    // Add GeoJSON layer to map
    L.geoJSON(data, {
      style: { color: "red", weight: 2 }
    }).addTo(map);
  })
  .catch(err => console.error("Error loading GeoJSON:", err));




let vesselLayer = L.layerGroup().addTo(map);

async function searchVessels(){
    const lon = parseFloat(document.getElementById("lon").value);
    const lat = parseFloat(document.getElementById("lat").value);
    const distance = parseInt(document.getElementById("distance").value) || 10000;

    if (isNaN(lon) || isNaN(lat)) {
        alert("Please enter valid longitude and latitude");
        return;
    }

    const url = `/entities/vessel/nearby_vessels?longitude=${lon}&latitude=${lat}&max_distance=${distance}`;
    //console.log("Fetching:", url);



    try {
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        console.log("Received vessels:", data);

        // ✅ Clear old markers before adding new ones
        vesselLayer.clearLayers();
        map.setView([lat, lon], 12);

        // Add new markers
		data.vessels.forEach(v => {
			const coords = v.coordinates;

      

			const marker = L.marker([coords[1], coords[0]]).addTo(vesselLayer).bindPopup(v.id).bindTooltip(v.id, {permanent: false, direction: "top"});

			// ✅ On marker click, fetch history & draw path
                marker.on("click", () => {
                    const targetUrl = `/entities/vessel/details?vessel_id=${encodeURIComponent(v.id)}`;
                    //window.location.href = targetUrl;
                    window.open(targetUrl, "_blank");
                });
      
			
		});


    } catch (error) {
        console.error("Error fetching vessels:", error);
    }

}

setInterval(searchVessels, 60000);
</script>
</body>
</html>
